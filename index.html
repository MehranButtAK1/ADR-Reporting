<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient ADR Reporting Portal By HCK Pharma</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f9;
        }
        .container {
            max-width: 600px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            text-align: center; /* Center alignment for buttons/scanner */
        }
        h1 {
            color: #2c3e50;
        }
        .start-options {
            margin-bottom: 25px;
        }
        .start-options button {
            background-color: #2980b9;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
            width: 90%; /* Make buttons full width */
            max-width: 250px;
        }
        .start-options button:hover {
            background-color: #3498db;
        }
        /* Style the hidden file input */
        #gallery-input {
            display: none;
        }
        /* QR Reader area */
        #qr-reader {
            width: 100%;
            border: 2px solid #3498db;
            border-radius: 5px;
            margin-bottom: 20px;
            min-height: 250px;
            display: none; /* Hidden by default */
        }
        .drug-details, .adr-form {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-top: 15px;
            text-align: left;
        }
        .drug-details h2 {
            color: #27ae60;
        }
        .adr-form {
            background-color: #ecf0f1;
        }
        input[type="text"], textarea {
            width: 95%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .adr-form button {
             background-color: #e74c3c;
             width: auto;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>üíä QR Reporting Portal (ADR)</h1>

    <div class="start-options" id="start-options">
        <button id="camera-button">üì∏ Scan via Camera</button>
        <button id="gallery-trigger-button">üñºÔ∏è Select from Gallery</button>
        <input type="file" id="gallery-input" accept="image/*">
    </div>

    <div id="qr-reader"></div>
    <div id="qr-reader-results"></div>

    <div class="drug-details" id="drug-details-section" style="display:none;">
        <h2>Drug Information (Auto-Fetched)</h2>
        <p><strong>Drug Name:</strong> <span id="drug-name"></span></p>
        <p><strong>Manufacturer:</strong> <span id="manufacturer"></span></p>
        <p><strong>Batch No:</strong> <span id="batch-no"></span></p>
        <p><strong>Known ADRs:</strong> <span id="known-adrs"></span></p>
        
        <button id="report-button" style="background-color:#e67e22;">Report New Reaction</button>
    </div>

    <form class="adr-form" id="adr-report-form" style="display:none;">
        <h2>üö® Report New Adverse Reaction</h2>
        
        <label for="reaction-type">Reaction Type/Symptoms:</label>
        <input type="text" id="reaction-type" required>

        <label for="reaction-details">Detailed Description:</label>
        <textarea id="reaction-details" rows="4" required></textarea>

        <label for="patient-contact">Contact (Optional):</label>
        <input type="text" id="patient-contact" placeholder="Phone or Email">

        <button type="submit">Submit ADR Report</button>
    </form>

</div>

<script>
    // --- DATA MOCKUP ---
    const drugDatabase = {
        "AMX-002": { 
            name: "Amoxicillin 500mg",
            manufacturer: "ABC Pharma",
            batch: "AMX-002",
            adrs: "Rash, Nausea, Vomiting, Diarrhea"
        },
        "CET-101": {
            name: "Cetirizine 10mg",
            manufacturer: "X-Z Pharmaceuticals",
            batch: "CET-101",
            adrs: "Drowsiness, Dry Mouth, Headache"
        },
    };

    let html5QrcodeScanner = null;
    const qrReaderId = "qr-reader";
    const startOptions = document.getElementById('start-options');

    // --- CORE LOGIC ---
    function processDecodedText(decodedText) {
        
        // Stop the scanner if it's running
        if (html5QrcodeScanner) {
            html5QrcodeScanner.stop();
        }

        const cleanText = decodedText.trim().toUpperCase(); 
        const drugData = drugDatabase[cleanText];

        // Hide unnecessary elements and display results
        document.getElementById(qrReaderId).style.display = 'none';
        
        if (drugData) {
            document.getElementById('drug-name').textContent = drugData.name;
            document.getElementById('manufacturer').textContent = drugData.manufacturer;
            document.getElementById('batch-no').textContent = drugData.batch;
            document.getElementById('known-adrs').textContent = drugData.adrs;
            
            document.getElementById('drug-details-section').style.display = 'block';
            document.getElementById('qr-reader-results').innerHTML = `<p style="color:#27ae60; font-weight:bold;">‚úÖ Drug Found: ${drugData.name}</p>`;

        } else {
            document.getElementById('qr-reader-results').innerHTML = `<p style="color:#e74c3c; font-weight:bold;">‚ùå Error: Batch ID "${cleanText}" not found.</p>`;
            // Show options again if drug is not found
            startOptions.style.display = 'block';
        }
    }

    // --- BUTTON HANDLERS ---
    
    // 1. Camera Scan Handler
    document.getElementById('camera-button').addEventListener('click', () => {
        startOptions.style.display = 'none';
        document.getElementById(qrReaderId).style.display = 'block';
        document.getElementById('qr-reader-results').innerHTML = `<p style="color:#2c3e50;">Loading camera...</p>`;

        // Initialize and start scanner
        html5QrcodeScanner = new Html5QrcodeScanner(
            qrReaderId, 
            { fps: 10, qrbox: {width: 250, height: 250} },
            /* verbose= */ false);

        html5QrcodeScanner.render(
            (decodedText, decodedResult) => {
                // Success callback
                html5QrcodeScanner.clear().then(() => {
                    processDecodedText(decodedText);
                });
            }, 
            (error) => {
                // Failure callback (e.g., camera permission denied)
                document.getElementById('qr-reader-results').innerHTML = `<p style="color:#e74c3c;">‚ö†Ô∏è Camera access failed. Try selecting from Gallery.</p>`;
                document.getElementById(qrReaderId).style.display = 'none';
                startOptions.style.display = 'block';
            }
        );
    });

    // 2. Gallery Trigger Handler (Just simulates click on hidden file input)
    document.getElementById('gallery-trigger-button').addEventListener('click', () => {
        document.getElementById('gallery-input').click();
    });

    // 3. Gallery File Selection Handler
    document.getElementById('gallery-input').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) {
            return;
        }

        startOptions.style.display = 'none';
        document.getElementById('qr-reader-results').innerHTML = `<p style="color:#2c3e50;">Scanning uploaded image...</p>`;

        // Use the library to scan the uploaded image file
        const html5QrCode = new Html5Qrcode(qrReaderId);
        html5QrCode.scanFile(file, true)
            .then(decodedText => {
                // Success
                processDecodedText(decodedText);
            })
            .catch(err => {
                // Error (e.g., no QR code found in the image)
                document.getElementById('qr-reader-results').innerHTML = `<p style="color:#e74c3c;">‚ùå Could not find QR code in the image. Try another image.</p>`;
                startOptions.style.display = 'block';
            });
    });

    // --- ADR FORM LOGIC ---
    
    document.getElementById('report-button').addEventListener('click', () => {
        document.getElementById('adr-report-form').style.display = 'block';
        document.getElementById('report-button').style.display = 'none'; 
    });

    document.getElementById('adr-report-form').addEventListener('submit', function(event) {
        event.preventDefault(); 
        
        const reportedDrug = document.getElementById('drug-name').textContent;
        const reportedBatch = document.getElementById('batch-no').textContent;

        alert(`Thank you! Your report for ${reportedDrug} (Batch: ${reportedBatch}) has been successfully submitted.`);
        
        // Reset the interface
        document.getElementById('drug-details-section').style.display = 'none';
        document.getElementById('adr-report-form').style.display = 'none';
        document.getElementById('qr-reader-results').innerHTML = ``;
        startOptions.style.display = 'block';
        document.getElementById('report-button').style.display = 'block'; 
    });

</script>

</body>
</html>
